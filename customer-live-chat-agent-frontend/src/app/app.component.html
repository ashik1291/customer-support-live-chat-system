<div class="agent-shell" [class.agent-shell--has-chats]="activeChats().length">
  <section class="signin-card" *ngIf="!agentSession(); else dashboard">
    <h1>Agent Console</h1>
    <p>Sign in to start helping customers in real time.</p>
    <form [formGroup]="loginForm" (ngSubmit)="signIn()">
      <label>
        <span>Agent ID</span>
        <input formControlName="agentId" placeholder="agent-001" />
        <small class="error" *ngIf="loginForm.controls.agentId.invalid && loginForm.controls.agentId.touched">
          Please enter your agent identifier.
        </small>
      </label>
      <label>
        <span>Display name</span>
        <input formControlName="displayName" placeholder="Alex Carter" />
        <small class="error" *ngIf="loginForm.controls.displayName.invalid && loginForm.controls.displayName.touched">
          Customers will see this name in the chat.
        </small>
      </label>
      <button class="btn btn-primary" type="submit">Sign in</button>
    </form>
  </section>

  <ng-template #dashboard>
    <div class="console">
      <header class="console__header">
        <div class="console__titles">
          <h1>Agent Desk</h1>
          <p>{{ statusText() }}</p>
        </div>
        <div class="console__meta">
          <div class="console__agent">
            <strong>{{ agentSession()?.displayName }}</strong>
            <span>{{ agentSession()?.agentId }}</span>
          </div>
          <button type="button" class="btn btn-secondary" (click)="signOut()">Sign out</button>
        </div>
      </header>

      <div class="workspace-layout">
        <section class="queue-panel">
          <div class="queue-panel__header">
            <div>
              <h2>Live Requests</h2>
              <p>Customers waiting for assistance</p>
            </div>
            <div class="queue-panel__actions">
              <span class="badge">{{ queue().length }}</span>
              <button type="button" class="icon-button" (click)="refreshQueue()" aria-label="Refresh queue">↻</button>
            </div>
          </div>

          <div class="queue-panel__body">
            <p class="panel-error" *ngIf="queueError()">{{ queueError() }}</p>
          <p class="panel-error" *ngIf="chatError()">{{ chatError() }}</p>
            <p class="panel-hint" *ngIf="activeChats().length >= maxConcurrentChats">
              Maximum concurrent chats reached. Close a chat to accept another.
            </p>

            <ng-container *ngIf="queue().length; else emptyQueue">
              <div class="queue-cards-viewport">
                <div class="queue-cards">
                  <article class="queue-card" *ngFor="let entry of paginatedQueue(); trackBy: trackQueue">
                    <div class="queue-card__chips">
                      <span class="priority-badge">{{ queuePriority(entry) || '—' }}</span>
                      <span class="queue-card__chip">{{ (entry.channel || 'web') | uppercase }}</span>
                      <span class="queue-card__chip">{{ entry.enqueuedAt ? (entry.enqueuedAt | date : 'shortTime') : '—' }}</span>
                      <button
                        type="button"
                        class="btn btn-primary btn--compact queue-card__accept"
                        (click)="joinConversation(entry)"
                        [disabled]="isConnecting() || activeChats().length >= maxConcurrentChats"
                      >
                        Accept
                      </button>
                    </div>

                    <div class="queue-card__info">
                      <h3 class="queue-card__name">{{ queueCustomerLabel(entry) }}</h3>
                      <p class="queue-card__meta">Visitor ID <span>{{ entry.conversationId }}</span></p>
                      <p class="queue-card__meta" *ngIf="entry.customerPhone">Phone <span>{{ entry.customerPhone }}</span></p>
                    </div>

                    <div class="queue-card__error" *ngIf="queueActionErrors()[entry.conversationId]">
                      {{ queueActionErrors()[entry.conversationId] }}
                    </div>
                  </article>
                </div>
              </div>

              <div class="queue-pagination" *ngIf="totalQueuePages() > 1">
                <button type="button" class="icon-button" (click)="previousQueuePage()" [disabled]="queuePage() === 0">
                  ‹
                </button>
                <span>Page {{ queuePage() + 1 }} of {{ totalQueuePages() }}</span>
                <button
                  type="button"
                  class="icon-button"
                  (click)="nextQueuePage()"
                  [disabled]="queuePage() + 1 >= totalQueuePages()"
                >
                  ›
                </button>
              </div>
            </ng-container>

            <ng-template #emptyQueue>
              <div class="empty-state">
                <p>No customers are waiting right now. We’ll refresh the queue automatically.</p>
              </div>
            </ng-template>

          </div>

        </section>

        <section class="chat-popups" *ngIf="activeChats().length">
          <div class="chat-popup" *ngFor="let chat of activeChats(); trackBy: trackChat">
            <div class="chat-widget" [class.chat-widget--ended]="chat.stage === AgentStage.Ended">
              <header class="chat-widget__header">
                <div class="chat-widget__identity">
                  <h2>{{ customerDisplayLabel(chat) }}</h2>
                </div>
                <div class="chat-widget__header-actions">
                  <span class="chat-widget__status">{{ chat.statusText }}</span>
                  <button
                    type="button"
                    class="close-button"
                    (click)="chat.stage === AgentStage.Ended ? dismissChat(chat.id) : closeConversation(chat.id)"
                    [disabled]="chat.isSending || chat.isConnecting"
                    aria-label="Close chat"
                  >
                    {{ chat.stage === AgentStage.Ended ? 'Dismiss' : 'Close' }}
                  </button>
                </div>
              </header>

              <div class="chat-widget__body">
                <div class="chat-connecting" *ngIf="chat.isConnecting">
                  <span class="spinner" aria-hidden="true"></span>
                  <p>Connecting to the customer…</p>
                </div>

                <div
                  class="chat-history"
                  [class.chat-history--empty]="!chat.messages.length"
                  #chatHistory
                  [attr.data-conversation-id]="chat.id"
                >
                  <article
                    *ngFor="let message of chat.messages; trackBy: trackMessage"
                    [ngClass]="messageClasses(message)"
                  >
                    <header>
                      <span class="sender">{{ renderMessageSender(message) }}</span>
                      <time>{{ message.timestamp | date : 'shortTime' }}</time>
                    </header>
                    <p>{{ message.content }}</p>
                  </article>

                  <div class="chat-history__placeholder" *ngIf="!chat.messages.length && !chat.isConnecting">
                    <p>No messages yet — say hello to start the conversation.</p>
                  </div>
                </div>

                <div class="chat-error" *ngIf="chat.errorText">{{ chat.errorText }}</div>

                <form
                  *ngIf="chat.stage !== AgentStage.Ended"
                  class="composer"
                  [formGroup]="chat.messageForm"
                  (ngSubmit)="sendMessage(chat.id)"
                >
                  <label class="sr-only" for="agent-message-{{ chat.id }}">Type your message</label>
                  <textarea
                    id="agent-message-{{ chat.id }}"
                    formControlName="content"
                    rows="3"
                    placeholder="Write a reply…"
                    [disabled]="chat.stage !== AgentStage.Active || chat.isSending"
                    (keydown.enter)="onComposerKeydown($event, chat.id)"
                  ></textarea>
                  <div class="composer__actions">
                    <button
                      type="submit"
                      class="btn btn-primary"
                      [disabled]="chat.messageForm.invalid || chat.stage !== AgentStage.Active || chat.isSending"
                    >
                      {{ chat.isSending ? 'Sending…' : 'Send' }}
                    </button>
                  </div>
                </form>

                <div class="chat-widget__footer" *ngIf="chat.stage === AgentStage.Ended">
                  <p>This chat is closed. Dismiss it or pick another request from the queue.</p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </ng-template>
</div>
